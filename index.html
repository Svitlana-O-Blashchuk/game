<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>The Quest for the Lost Artifact</title>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;1,400;1,600&display=swap');
		
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: 'Crimson Text', serif;
			background: #1a1612;
			background-image: 
				radial-gradient(circle at 25% 25%, rgba(101, 67, 33, 0.1) 0%, transparent 50%),
				radial-gradient(circle at 75% 75%, rgba(139, 69, 19, 0.05) 0%, transparent 50%);
			min-height: 100vh;
			color: #d4c4a0;
			overflow-x: hidden;
			position: relative;
		}
		
		body::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-image: 
				url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="0.5" fill="%23654321" opacity="0.1"/><circle cx="80" cy="40" r="0.3" fill="%238B4513" opacity="0.08"/><circle cx="40" cy="80" r="0.4" fill="%23654321" opacity="0.12"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
			opacity: 0.3;
			pointer-events: none;
		}
		
		.book-spine {
			position: absolute;
			left: 0;
			top: 0;
			bottom: 0;
			width: 40px;
			background: linear-gradient(to right, #2d1810, #3e2317, #2d1810);
			border-right: 3px solid #8B4513;
			box-shadow: inset -10px 0 20px rgba(0, 0, 0, 0.5);
		}
		
		.container {
			max-width: 900px;
			margin: 0 auto;
			padding: 40px 40px 40px 80px;
			min-height: 100vh;
			position: relative;
		}
		
		.title {
			font-family: 'Cinzel', serif;
			font-size: 3.8rem;
			font-weight: 700;
			color: #d4af37;
			margin-bottom: 15px;
			text-align: center;
			text-shadow: 
				3px 3px 0px #8B4513,
				6px 6px 10px rgba(0, 0, 0, 0.8),
				0 0 30px rgba(212, 175, 55, 0.3);
			position: relative;
			letter-spacing: 2px;
		}
		
		.subtitle {
			font-family: 'Crimson Text', serif;
			font-size: 1.6rem;
			color: #b8860b;
			text-align: center;
			margin-bottom: 60px;
			font-style: italic;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
			opacity: 0.9;
		}
		
		.intro-text {
			font-size: 1.2rem;
			line-height: 1.9;
			color: #c9b037;
			margin-bottom: 25px;
			text-align: justify;
			font-weight: 400;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
			text-indent: 2rem;
		}
		
		.character-mention {
			color: #d4af37;
			font-weight: 600;
			text-shadow: 0 0 5px rgba(212, 175, 55, 0.4);
		}
		
		.rule-number {
			font-family: 'Cinzel', serif;
			font-size: 2.8rem;
			font-weight: 700;
			color: #d4af37;
			margin: 50px 0 30px 0;
			text-align: left;
			position: relative;
			text-shadow: 
				2px 2px 0px #8B4513,
				4px 4px 8px rgba(0, 0, 0, 0.8);
			letter-spacing: 3px;
		}
		
		.setup-text {
			font-size: 1.4rem;
			line-height: 2;
			color: #d4c4a0;
			margin: 40px 0;
			font-style: normal;
			text-align: justify;
			font-family: 'Crimson Text', serif;
			font-weight: 400;
			position: relative;
			text-indent: 2rem;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
		}
		
		.rule-box {
			background: linear-gradient(135deg, rgba(26, 18, 10, 0.8), rgba(45, 24, 16, 0.6));
			border: 3px solid #8B4513;
			border-radius: 0;
			padding: 30px;
			margin: 40px 0;
			position: relative;
			font-weight: 400;
			font-style: italic;
			box-shadow: 
				inset 0 0 20px rgba(0, 0, 0, 0.5),
				0 8px 16px rgba(0, 0, 0, 0.6),
				0 0 30px rgba(139, 69, 19, 0.2);
		}
		
		.rule-box strong {
			color: #d4af37;
			font-family: 'Cinzel', serif;
			font-size: 1.2rem;
			text-transform: uppercase;
			font-weight: 600;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
			letter-spacing: 2px;
		}
		
		.next-btn {
			background: linear-gradient(135deg, #2d1810, #3e2317);
			color: #d4af37;
			border: 3px solid #8B4513;
			padding: 15px 40px;
			border-radius: 0;
			font-size: 1.2rem;
			font-weight: 600;
			font-family: 'Cinzel', serif';
			cursor: pointer;
			transition: all 0.3s ease;
			display: block;
			margin: 50px auto;
			position: relative;
			text-transform: uppercase;
			letter-spacing: 2px;
			box-shadow: 
				0 6px 12px rgba(0, 0, 0, 0.6),
				inset 0 1px 2px rgba(212, 175, 55, 0.2);
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
		}
		
		.next-btn:hover {
			background: linear-gradient(135deg, #3e2317, #4a2b1a);
			color: #f4d03f;
			box-shadow: 
				0 8px 16px rgba(0, 0, 0, 0.8),
				inset 0 1px 2px rgba(212, 175, 55, 0.4),
				0 0 20px rgba(212, 175, 55, 0.3);
			transform: translateY(-2px);
		}
		
		.hidden {
			display: none;
		}
		
		.fade-in {
			animation: fadeIn 1.2s ease-in;
		}
		
		@keyframes fadeIn {
			from { 
				opacity: 0; 
				transform: translateY(30px);
			}
			to { 
				opacity: 1; 
				transform: translateY(0);
			}
		}
		
		.quest-ui-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 20px 0;
			margin-bottom: 40px;
			border-bottom: 2px solid rgba(139, 69, 19, 0.4);
			position: relative;
		}
		
		.round-counter {
			position: absolute;
			left: 50%;
			transform: translateX(-50%);
			z-index: 10;
		}
		
		.round-circle {
			width: 120px;
			height: 120px;
			border-radius: 50%;
			background: linear-gradient(135deg, #2d1810, #3e2317);
			border: 4px solid #d4af37;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			box-shadow: 0 8px 16px rgba(0, 0, 0, 0.6);
		}
		
		.round-label {
			font-family: 'Cinzel', serif;
			font-size: 0.9rem;
			color: #b8860b;
			font-weight: 600;
			text-transform: uppercase;
		}
		
		.round-number {
			font-family: 'Cinzel', serif;
			font-size: 2.5rem;
			color: #d4af37;
			font-weight: 700;
		}
		
		.abilities-area {
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			min-width: 200px;
		}
		
		.abilities-header {
			display: flex;
			align-items: center;
			gap: 10px;
			background: linear-gradient(135deg, rgba(139, 0, 139, 0.2), rgba(75, 0, 130, 0.3));
			border: 2px solid #8B008B;
			border-radius: 10px;
			padding: 10px 15px;
			margin-bottom: 15px;
		}
		
		.abilities-header .ability-icon {
			font-size: 1.5rem;
			color: #DDA0DD;
		}
		
		.abilities-header .ability-label {
			font-family: 'Cinzel', serif;
			font-size: 0.9rem;
			color: #DDA0DD;
			font-weight: 600;
			text-transform: uppercase;
		}
		
		.abilities-container {
			display: flex;
			flex-direction: column;
			gap: 8px;
			min-height: 20px;
		}
		
		.ability-button {
			background: linear-gradient(135deg, rgba(139, 0, 139, 0.3), rgba(75, 0, 130, 0.4));
			border: 2px solid #8B008B;
			border-radius: 8px;
			padding: 8px 12px;
			color: #DDA0DD;
			font-family: 'Crimson Text', serif;
			font-size: 0.9rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			min-width: 150px;
			position: relative;
		}
		
		.ability-button.active {
			background: linear-gradient(135deg, rgba(34, 139, 34, 0.4), rgba(0, 128, 0, 0.5));
			border-color: #32CD32;
			color: #90EE90;
			box-shadow: 0 0 10px rgba(50, 205, 50, 0.5);
		}
		
		.ability-button.used {
			background: linear-gradient(135deg, rgba(105, 105, 105, 0.3), rgba(69, 69, 69, 0.4));
			border-color: #696969;
			color: #A9A9A9;
			cursor: not-allowed;
			opacity: 0.5;
		}
		
		.ability-button:not(.used):not(.active):hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
		}
		
		.mana-counters {
			display: flex;
			gap: 15px;
		}
		
		.mana-counter {
			display: flex;
			flex-direction: column;
			align-items: center;
			border-radius: 12px;
			padding: 12px 15px;
			min-width: 60px;
		}
		
		.white-mana {
			background: linear-gradient(135deg, rgba(245, 245, 220, 0.2), rgba(255, 255, 255, 0.1));
			border: 2px solid #F5F5DC;
		}
		
		.red-mana {
			background: linear-gradient(135deg, rgba(178, 34, 34, 0.2), rgba(139, 0, 0, 0.3));
			border: 2px solid #B22222;
		}
		
		.blue-mana {
			background: linear-gradient(135deg, rgba(70, 130, 180, 0.2), rgba(0, 0, 139, 0.3));
			border: 2px solid #4682B4;
		}
		
		.mana-symbol {
			font-size: 1.8rem;
			margin-bottom: 5px;
		}
		
		.white-mana .mana-symbol { color: #F5F5DC; }
		.red-mana .mana-symbol { color: #FF6B6B; }
		.blue-mana .mana-symbol { color: #87CEEB; }
		
		.mana-count {
			font-family: 'Cinzel', serif;
			font-size: 1.4rem;
			font-weight: 700;
		}
		
		.white-mana .mana-count { color: #F5F5DC; }
		.red-mana .mana-count { color: #FF6B6B; }
		.blue-mana .mana-count { color: #87CEEB; }
		
		.ally-selection {
			margin: 40px 0;
			width: 100%;
		}
		
		.ally-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-top: 30px;
			width: 100%;
		}
		
		.ally-option {
			background: linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(212, 175, 55, 0.2));
			border: 3px solid #8B4513;
			border-radius: 15px;
			padding: 15px;
			cursor: pointer;
			transition: all 0.3s ease;
			text-align: center;
			box-shadow: 
				0 6px 12px rgba(0, 0, 0, 0.4),
				inset 0 1px 2px rgba(212, 175, 55, 0.1);
			position: relative;
			display: flex;
			justify-content: center;
		            align-items: center;
		}
		
		.ally-option::before {
			content: '';
			position: absolute;
			top: -3px;
			left: -3px;
			right: -3px;
			bottom: -3px;
			background: linear-gradient(45deg, #b7791f, #d4af37, #b7791f);
			border-radius: 18px;
			z-index: -1;
			opacity: 0.6;
		}
		
		.ally-option:hover {
			background: linear-gradient(135deg, rgba(139, 69, 19, 0.5), rgba(212, 175, 55, 0.4));
			border-color: #d4af37;
			transform: translateY(-5px);
			box-shadow: 
				0 12px 24px rgba(0, 0, 0, 0.6),
				inset 0 1px 2px rgba(212, 175, 55, 0.3),
				0 0 20px rgba(212, 175, 55, 0.3);
		}
		
		.ally-option img {
			max-width: 100%;
			height: auto;
			display: block;
		}
		
		.hand-input-container {
			margin: 30px 0;
			text-align: center;
		}
		
		.hand-input {
			width: 100%;
			max-width: 500px;
			padding: 15px;
			border: 2px solid #8B4513;
			border-radius: 8px;
			background: rgba(26, 18, 10, 0.6);
			color: #d4c4a0;
			font-family: 'Crimson Text', serif;
			font-size: 1rem;
			margin-bottom: 20px;
		}
		
		.hand-input:focus {
			outline: none;
			border-color: #d4af37;
			box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
		}
		
		.hand-buttons {
			display: flex;
			gap: 20px;
			justify-content: center;
			flex-wrap: wrap;
		}
		
		.game-board {
			text-align: left;
			padding: 20px 0;
		}
		
		.board-section {
			margin-bottom: 40px;
		}
		
		.board-section h3 {
			font-family: 'Cinzel', serif;
			color: #d4af37;
			font-size: 1.5rem;
			margin-bottom: 20px;
			text-align: center;
		}
		
		.cards-on-board {
			display: flex;
			flex-wrap: wrap;
			gap: 15px;
			justify-content: center;
			min-height: 60px;
			padding: 20px;
			background: rgba(139, 69, 19, 0.1);
			border: 1px solid rgba(139, 69, 19, 0.3);
			border-radius: 10px;
		}
		
		.board-card {
			background: linear-gradient(135deg, rgba(139, 69, 19, 0.3), rgba(212, 175, 55, 0.2));
			border: 1px solid #8B4513;
			border-radius: 8px;
			padding: 10px 15px;
			color: #d4c4a0;
			font-family: 'Crimson Text', serif;
			font-weight: 600;
		}

		/* Land interaction states */
		.board-card.land-card { cursor: pointer; }
		.board-card.land-used { cursor: not-allowed; opacity: 0.6; }
		/* Ready lands highlighted in blue */
		.board-card.land-ready {
			background: linear-gradient(135deg, rgba(70, 130, 180, 0.4), rgba(0, 0, 139, 0.35));
			border-color: #4682B4;
			box-shadow: 0 0 10px rgba(70, 130, 180, 0.6), inset 0 1px 2px rgba(255, 255, 255, 0.2);
		}
		.board-card.land-ready:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4), 0 0 14px rgba(70, 130, 180, 0.8);
		}
		
		.player-hand {
			display: flex;
			flex-wrap: wrap;
			gap: 15px;
			justify-content: center;
			padding: 20px;
			background: rgba(26, 18, 10, 0.3);
			border: 2px solid rgba(139, 69, 19, 0.4);
			border-radius: 10px;
			min-height: 120px;
		}
		
		.hand-card {
			background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(139, 69, 19, 0.3));
			border: 2px solid #8B4513;
			border-radius: 10px;
			padding: 15px;
			cursor: pointer;
			transition: all 0.3s ease;
			text-align: center;
			min-width: 120px;
		}
		
		.hand-card:hover {
			background: linear-gradient(135deg, rgba(212, 175, 55, 0.4), rgba(139, 69, 19, 0.5));
			border-color: #d4af37;
			transform: translateY(-3px);
			box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
		}
		
		.card-number {
			font-family: 'Cinzel', serif;
			color: #d4af37;
			font-weight: 700;
			font-size: 1rem;
			margin-bottom: 5px;
		}
		
		.card-type {
			font-family: 'Crimson Text', serif;
			color: #b8860b;
			font-size: 0.9rem;
			text-transform: capitalize;
			margin-bottom: 5px;
		}
		
		.card-name {
			font-family: 'Crimson Text', serif;
			color: #d4c4a0;
			font-size: 0.8rem;
			font-style: italic;
			margin-bottom: 8px;
		}
		
		.card-cost {
			display: flex;
			flex-wrap: wrap;
			gap: 6px;
			justify-content: center;
			margin-top: 10px;
			align-items: center;
		}
		
		.mana-cost {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: 24px;
			height: 24px;
			border-radius: 50%;
			font-size: 0.8rem;
			font-weight: 900;
			font-family: 'Cinzel', serif;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.9);
			border: 2px solid;
			box-shadow: 
				0 2px 4px rgba(0, 0, 0, 0.4),
				inset 0 1px 2px rgba(255, 255, 255, 0.2);
		}
		
		.white-cost {
			background: radial-gradient(circle, #FFFACD 30%, #F5F5DC 70%, #E6E6DA 100%);
			color: #2d1810;
			border-color: #D4AF37;
			text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.3);
		}
		
		.red-cost {
			background: radial-gradient(circle, #FF6B6B 30%, #B22222 70%, #8B0000 100%);
			color: #fff;
			border-color: #FF4500;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
		}
		
		.blue-cost {
			background: radial-gradient(circle, #87CEEB 30%, #4682B4 70%, #2F4F4F 100%);
			color: #fff;
			border-color: #00BFFF;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
		}
		
		.generic-cost {
			background: radial-gradient(circle, #C0C0C0 30%, #808080 70%, #696969 100%);
			color: #fff;
			border-color: #D3D3D3;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
		}
		
		.free-cost {
			font-size: 0.8rem;
			color: #90EE90;
			font-weight: 700;
			font-family: 'Cinzel', serif;
			text-shadow: 
				0 0 3px rgba(144, 238, 144, 0.8),
				1px 1px 2px rgba(0, 0, 0, 0.8);
			padding: 4px 8px;
			background: rgba(144, 238, 144, 0.1);
			border-radius: 12px;
			border: 1px solid rgba(144, 238, 144, 0.3);
		}
		
		.game-actions {
			text-align: center;
			margin-top: 30px;
		}

		.quest-title {
			font-family: 'Cinzel', serif;
			font-size: 2.5rem;
			color: #d4af37;
			font-weight: 700;
			margin-bottom: 30px;
			text-shadow: 2px 2px 0px #8B4513;
			letter-spacing: 2px;
			text-align: center;
		}
		
		.quest-description {
			font-family: 'Crimson Text', serif;
			font-size: 1.3rem;
			color: #d4c4a0;
			line-height: 1.8;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.6);
			max-width: 600px;
			margin: 0 auto 30px;
			text-align: center;
		}
	</style>
</head>
<body>
	<div class="book-spine"></div>
	
	<div class="container">
		<div id="intro" class="screen">
			<h1 class="title">The Quest for the Lost Artifact</h1>
			<p class="subtitle">An Adventure in the Modern World</p>
			
			<div class="intro-text">
				Dark clouds are gathering over Middle-earth... But this time, the danger threatens not only the magical world. 
				A powerful artifact, capable of destroying the boundary between worlds, has been lost in <strong>your</strong> world - 
				the world of 21st-century humans.
			</div>
			
			<div class="intro-text">
				<span class="character-mention">Aragorn</span>, <span class="character-mention">Legolas</span>, 
				<span class="character-mention">Gimli</span> and other heroes have crossed into the modern world, but they are completely 
				helpless here. Technology, urban hustle, modern customs - all of this seems like magic more complex 
				than any of Gandalf's spells.
			</div>
			
			<div class="intro-text">
				That's why they have turned to <strong>you</strong> - a modern person who knows this world like the back of their hand. 
				Only together can you find the lost artifact before time runs out...
			</div>
			
			<button class="next-btn" onclick="showRules()">Accept the Challenge</button>
		</div>

		<div id="rules" class="screen hidden">
			<h2 class="title" style="font-size: 3rem;">Tome of Rules</h2>
			
			<div id="rule1" class="rule-section">
				<div class="rule-number">Rule I</div>
				<div class="setup-text">
					You start your adventure with only one ally. The trust of the rest has to be earned during your adventure.
				</div>
				<div class="rule-box">
					<strong>Game Rule:</strong> Put one Ally in your hand. The rest have to be shuffled with the deck. 
					You can always use the ability of this character for a reduced mana cost, specifically one generic mana less.
					<br><br>
					<strong>How Hero Abilities Work:</strong>
					<ul style="margin-top: 15px; padding-left: 30px; list-style-type: disc;">
						<li style="margin-bottom: 10px;">To recruit a hero to your party, you must play their card by paying its mana cost</li>
						<li style="margin-bottom: 10px;">Once a hero joins your party, their ability button appears in the Abilities panel</li>
						<li style="margin-bottom: 10px;">The FIRST time you use a hero's ability on the turn they join, it's FREE</li>
						<li style="margin-bottom: 10px;">After that, each ability use costs 1 mana of any color (your choice)</li>
						<li style="margin-bottom: 10px;">Each ability can only be activated ONCE per turn</li>
						<li style="margin-bottom: 10px;">Ability effects last until the end of the current turn</li>
						<li style="margin-bottom: 10px;">At the start of a new turn, all abilities reset and can be used again</li>
					</ul>
				</div>
				<button class="next-btn" onclick="nextRule()">Continue Reading</button>
			</div>

			<div id="rule2" class="rule-section hidden">
				<div class="rule-number">Rule II</div>
				<div class="setup-text">
					What surprises in this adventure will await for you? The journey begins now, 
					and fate will present you with countless challenges, allies, and opportunities.
				</div>
				<div class="rule-box">
					<strong>Game Rule:</strong> Draw seven random cards from the deck. This is your hand. 
					You can play as many cards as you want during your turn if you pay their costs.
				</div>
				<button class="next-btn" onclick="nextRule()">Continue Reading</button>
			</div>

			<div id="rule3" class="rule-section hidden">
				<div class="rule-number">Rule III</div>
				<div class="setup-text">
					Time is passing and while you are in the wild, heroes in the real world... 
					it becomes harder and harder for them to find the artifact because they're losing connection - 
					they don't hear the voice of the artifact anymore.
				</div>
				<div class="rule-box">
					<strong>Game Rule:</strong> After you finish your turn, one of the Ways cards randomly gets destroyed. 
					So it becomes harder and harder to find the artifact with every subsequent turn.
				</div>
				<button class="next-btn" onclick="showQuestStart()">Begin the Adventure!</button>
			</div>

			<div id="gameStart" class="rule-section hidden">
				<div class="title" style="color: #2e7d32; font-size: 3.2rem;">The Quest Commences!</div>
				<div class="intro-text" style="text-align: center;">
					<p style="font-size: 1.5rem; margin-bottom: 30px; font-family: 'Crimson Text', serif;">
						The heroes of Middle-earth await your aid. The artifact must be found 
						before the connection between worlds is severed forever.
					</p>
					<p style="color: #d4af37; font-weight: bold; font-size: 1.4rem; font-family: 'Crimson Text', serif; margin-bottom: 50px;">
						May the ancient powers guide you, chosen helper of heroes!
					</p>
				</div>
				<button class="next-btn" onclick="startQuest()" style="background: linear-gradient(135deg, #2e7d32, #4caf50); border-color: #1b5e20; color: #c8e6c9; font-size: 1.4rem;">
					Enter the Quest
				</button>
			</div>
		</div>

		<div id="questScreen" class="screen hidden">
			<div class="quest-ui-bar">
				<div class="round-counter">
					<div class="round-circle">
						<div class="round-label">Round</div>
						<div class="round-number" id="roundNumber">1</div>
					</div>
				</div>

				<div class="abilities-area">
					<div class="abilities-header">
						<div class="ability-icon">⚡</div>
						<div class="ability-label">Abilities</div>
					</div>
					<div class="abilities-container" id="abilitiesContainer"></div>
				</div>

				<div class="mana-counters">
					<div class="mana-counter white-mana">
						<div class="mana-symbol">◇</div>
						<div class="mana-count" id="whiteMana">0</div>
					</div>
					<div class="mana-counter red-mana">
						<div class="mana-symbol">◆</div>
						<div class="mana-count" id="redMana">0</div>
					</div>
					<div class="mana-counter blue-mana">
						<div class="mana-symbol">◈</div>
						<div class="mana-count" id="blueMana">0</div>
					</div>
				</div>
			</div>

			<div class="quest-content">
				<div class="quest-title">The Search Begins...</div>
				<div class="quest-description">
					Your journey into the modern world starts here. The artifact's voice grows fainter with each passing moment.
				</div>
			</div>
		</div>
	</div>

	<script>
		let currentRule = 1;
		
		let gameState = {
			currentRound: 1,
			mana: { white: 0, red: 0, blue: 0 },
			hand: [],
			activeHeroes: [],
			abilities: [],
			deck: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37],
			discardPile: [],
			exiledCards: [],
			waysCardsRemaining: [25, 26, 27, 28, 29, 30, 31, 32, 33, 34],
			ally: null,
			cardsOnBoard: [],
			activeAbilities: [],
			usedAbilitiesThisTurn: [],
			heroesWithFreeActivationThisTurn: [],
			usedLandsThisTurn: [],
			wayCostReductionTurns: 0
		};

		let pendingAbilitySourceHero = null;
		
		const cardDatabase = {
			18: { type: 'hero', name: 'Treebeard', cost: { white: 1, blue: 1 }, ability: 'When you play a land, draw 1 card', password: null },
			19: { type: 'hero', name: 'Frodo', cost: { white: 2 }, ability: 'Ask for help with trial cards if stuck', password: null },
			20: { type: 'hero', name: 'Balin', cost: { red: 1, white: 1, any: 1 }, ability: 'Spend any color mana as if it were any other color', password: null },
			21: { type: 'hero', name: 'Legolas', cost: { blue: 2, white: 1 }, ability: 'Trial cards cost 1 less mana', password: null },
			22: { type: 'hero', name: 'Sam and Rosie', cost: { red: 1, blue: 1 }, ability: 'Draw an extra card', password: null },
			23: { type: 'hero', name: 'Gimli', cost: { red: 2, white: 1 }, ability: 'Trial card mana effects are doubled', password: null },
			24: { type: 'hero', name: 'Gollum', cost: { blue: 1, any: 1 }, ability: 'Take any card from discard pile to hand', password: null },
			1: { type: 'trial', cost: { red: 1 }, password: 'charoi', effect: 'Convert 1 white mana to 1 blue and 1 red mana' },
			2: { type: 'trial', cost: { white: 2 }, password: '12rulesforlife', effect: 'Way cards cost 1 less mana for the next two turns' },
			3: { type: 'trial', cost: { white: 1 }, password: 'denla', effect: 'Draw a new card' },
			4: { type: 'trial', cost: { any: 1 }, password: 'time', effect: 'Add 2 mana of any color' },
			5: { type: 'trial', cost: { any: 1, red: 1 }, password: '4', effect: 'Add one card to the hand' },
			6: { type: 'trial', cost: { white: 1 }, password: 'd3nbooga3rd2023!', effect: 'Add 3 mana (only if Path card played immediately after)' },
			7: { type: 'trial', cost: { blue: 1 }, password: 'sonogram', effect: 'Add 2 mana of any type your lands can produce' },
			8: { type: 'trial', cost: { white: 1, blue: 1 }, password: 'lacbleu', effect: 'Get one land card from deck to hand' },
			9: { type: 'trial', cost: { white: 1, red: 1 }, password: '18', effect: 'Tutor: choose any one card from deck to hand' },
			10: { type: 'trial', cost: { red: 1, blue: 1 }, password: 'http://www/ancientwisdom/com/rings', effect: 'Add 3 mana of any color' },
		    11: { type: 'land', password: 'isengardwhitehand', effect: 'Add 1 red mana' },
			12: { type: 'land', password: 'mountdoom', effect: 'Add 1 red mana' },
			13: { type: 'land', password: 'eyeofsauron', effect: 'Add 1 white mana' },
			14: { type: 'land', password: 'elthrai', effect: 'Add 1 white mana' },
			15: { type: 'land', password: 'ring', effect: 'Add 1 white mana' },
			16: { type: 'land', password: 'doorsofdurin', effect: 'Add 1 blue mana' },
			17: { type: 'land', password: 'starofarendil', effect: 'Add 1 blue mana' },
			35: { type: 'land', password: 'whitetreeofgondor', effect: 'Add 1 white or 1 blue mana', choices: ['white', 'blue'] },
			36: { type: 'land', password: 'palantinesphere', effect: 'Add 1 white or 1 red mana', choices: ['white', 'red'] },
			37: { type: 'land', password: 'sting', effect: 'Add 1 red or 1 blue mana', choices: ['red', 'blue'] },
			25: { type: 'way', cost: { white: 2, red: 1, blue: 1 }, password: '5', condition: 'Hero 24 must be active' },
			26: { type: 'way', cost: { white: 1, red: 1, blue: 1, any: 1 }, password: '33', condition: 'None' },
			27: { type: 'way', cost: { white: 2, red: 1, blue: 1 }, password: '', condition: '' },
			28: { type: 'way', cost: { white: 1, red: 1, blue: 1, any: 1 }, password: 'korokan', condition: 'Hero 19 must be active' },
			29: { type: 'way', cost: { white: 2, red: 2 }, password: 'love', condition: 'None' },
			30: { type: 'way', cost: { white: 3, red: 1 }, password: 'liege', condition: 'None' },
			31: { type: 'way', cost: { white: 3, blue: 1 }, password: 'paardenkracht', condition: 'None' },
			32: { type: 'way', cost: { white: 2, blue: 2 }, password: 'smeets', condition: 'Gimli and Balin must be in the party' },
			33: { type: 'way', cost: { white: 2, blue: 2 }, password: 'hmannetjezvhivvhjbddkjveg', condition: 'Legolas must be in the party' },
			34: { type: 'way', cost: { white: 4 }, password: 'ceeborn', condition: 'Legolas must be in the party' }
		};

		// ---- Persistence helpers ----
		const STORAGE_KEY = 'quest-progress-v1';

		function getCurrentScreen() {
			const quest = !document.getElementById('questScreen').classList.contains('hidden');
			if (quest) return 'quest';
			const rules = !document.getElementById('rules').classList.contains('hidden');
			if (rules) return 'rules';
			return 'intro';
		}

		function saveProgress() {
			try {
				const payload = {
					gameState,
					currentRule,
					screen: getCurrentScreen()
				};
				localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
			} catch (e) {}
		}

		function restoreProgress() {
			try {
				const raw = localStorage.getItem(STORAGE_KEY);
				if (!raw) return false;
				const data = JSON.parse(raw);
				if (!data || !data.gameState) return false;

				gameState = data.gameState;
				currentRule = data.currentRule || 1;

				document.getElementById('intro').classList.add('hidden');
				document.getElementById('rules').classList.add('hidden');
				document.getElementById('gameStart').classList.add('hidden');
				document.getElementById('questScreen').classList.add('hidden');

				if (data.screen === 'quest') {
					document.getElementById('questScreen').classList.remove('hidden');
					updateManaDisplay();
					updateWayReductionAbilityUI();
					const abilitiesContainer = document.getElementById('abilitiesContainer');
					if (abilitiesContainer) {
						abilitiesContainer.innerHTML = '';
						gameState.activeHeroes.forEach(heroNumber => {
							const hero = cardDatabase[heroNumber];
							addAbility(heroNumber, hero.ability, false);
						});
					}
					displayGameBoard();
				} else if (data.screen === 'rules') {
					document.getElementById('rules').classList.remove('hidden');
					['rule1','rule2','rule3','gameStart'].forEach(id => document.getElementById(id).classList.add('hidden'));
					const ruleId = currentRule >= 1 && currentRule <= 3 ? `rule${currentRule}` : 'rule1';
					document.getElementById(ruleId).classList.remove('hidden');
				} else {
					document.getElementById('intro').classList.remove('hidden');
				}
				return true;
			} catch {
				return false;
			}
		}

		function clearProgress() {
			try { localStorage.removeItem(STORAGE_KEY); } catch {}
		}

		window.addEventListener('DOMContentLoaded', () => {
			restoreProgress();
		});

		window.addEventListener('beforeunload', () => {
			saveProgress();
		});
		
		function showRules() {
			document.getElementById('intro').classList.add('hidden');
			document.getElementById('rules').classList.remove('hidden');
			document.getElementById('rules').classList.add('fade-in');
			saveProgress();
		}
		
		function nextRule() {
			document.getElementById('rule' + currentRule).classList.add('hidden');
			currentRule++;
			document.getElementById('rule' + currentRule).classList.remove('hidden');
			document.getElementById('rule' + currentRule).classList.add('fade-in');
			saveProgress();
		}
		
		function showQuestStart() {
			document.getElementById('rule3').classList.add('hidden');
			document.getElementById('gameStart').classList.remove('hidden');
			document.getElementById('gameStart').classList.add('fade-in');
			saveProgress();
		}
		
		function startQuest() {
			document.getElementById('gameStart').classList.add('hidden');
			document.getElementById('questScreen').classList.remove('hidden');
			document.getElementById('questScreen').classList.add('fade-in');
			initializeGame();
			saveProgress();
		}
		
		function initializeGame() {
			showAllySelection();
		}
		
		function showAllySelection() {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Choose Your Starting Ally</div>
				<div class="quest-description">
					You begin your quest with one trusted ally. Choose wisely, as their ability will be available throughout your entire adventure.
				</div>
				<div class="ally-selection">
					<div class="ally-grid">
						<div class="ally-option" onclick="selectAlly(18)">
							<img src="18.png" alt="Hero #18" style="width: 180px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
						</div>
						<div class="ally-option" onclick="selectAlly(19)">
							<img src="19.png" alt="Hero #19" style="width: 180px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
						</div>
						<div class="ally-option" onclick="selectAlly(20)">
							<img src="20.png" alt="Hero #20" style="width: 180px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
						</div>
						<div class="ally-option" onclick="selectAlly(21)">
							<img src="21.png" alt="Hero #21" style="width: 180px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
						</div>
						<div class="ally-option" onclick="selectAlly(22)">
							<img src="22.png" alt="Hero #22" style="width: 180px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
						</div>
						<div class="ally-option" onclick="selectAlly(23)">
							<img src="23.png" alt="Hero #23" style="width: 180px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
						</div>
						<div class="ally-option" onclick="selectAlly(24)">
							<img src="24.png" alt="Hero #24" style="width: 180px; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
						</div>
					</div>
				</div>
			`;
		}
		
		function selectAlly(heroNumber) {
			gameState.ally = heroNumber;
			gameState.activeHeroes.push(heroNumber);
			gameState.cardsOnBoard.push(heroNumber);
			gameState.deck = gameState.deck.filter(card => card !== heroNumber);
			if (!gameState.heroesWithFreeActivationThisTurn.includes(heroNumber)) {
				gameState.heroesWithFreeActivationThisTurn.push(heroNumber);
			}
			const hero = cardDatabase[heroNumber];
			addAbility(heroNumber, hero.ability, true);
			saveProgress();
			showDeckShuffle();
		}
		
		function showDeckShuffle() {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Prepare Your Deck</div>
				<div class="quest-description">
					Your ally <strong>${cardDatabase[gameState.ally].name}</strong> is ready to help!<br><br>
					Now shuffle all remaining heroes into the deck, then shuffle the entire deck and draw 7 cards.
				</div>
				<div style="background: rgba(139, 69, 19, 0.2); border: 1px solid rgba(139, 69, 19, 0.4); border-radius: 10px; padding: 25px; margin: 30px 0; text-align: left;">
					<p style="margin-bottom: 10px; color: #d4c4a0;"><strong style="color: #d4af37;">Instructions:</strong></p>
					<p style="margin-bottom: 10px; color: #d4c4a0;">1. Shuffle all cards (except your ally) together</p>
					<p style="margin-bottom: 10px; color: #d4c4a0;">2. Draw the first 7 cards from your shuffled deck</p>
					<p style="margin-bottom: 10px; color: #d4c4a0;">3. Look at your hand and decide if you want to keep it</p>
					<p style="color: #d4c4a0;">4. You can reshuffle and draw again ONE more time if needed</p>
				</div>
				<button class="next-btn" onclick="startHandSelection()">I've Shuffled - Draw My Hand</button>
			`;
		}
		
		function startHandSelection() {
			showHandInput(1);
		}
		
		function showHandInput(attempt) {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Your Hand (Attempt ${attempt}/2)</div>
				<div class="quest-description">
					Enter the 7 card numbers you drew from your deck, separated by spaces.<br>
					Example: 1 3 11 15 20 25 8
				</div>
				<div class="hand-input-container">
					<input type="text" id="handInput" placeholder="Enter card numbers: 1 3 11 15 20 25 8" class="hand-input">
					<div class="hand-buttons">
						<button class="next-btn" onclick="processHand()">Keep This Hand</button>
						${attempt === 1 ? '<button class="next-btn" onclick="reshuffleHand()" style="background: #8B4513;">Reshuffle (1 time only)</button>' : ''}
					</div>
				</div>
			`;
		}
		
		function processHand() {
			const input = document.getElementById('handInput');
			if (!input || !input.value.trim()) {
				showMessage('Please enter card numbers!');
				return;
			}
			
			const cardNumbers = input.value.split(/\s+/).map(num => parseInt(num.trim())).filter(num => !isNaN(num));
			
			if (cardNumbers.length !== 7) {
				showMessage('Please enter exactly 7 card numbers!');
				return;
			}
			
			const invalidCards = cardNumbers.filter(card => !gameState.deck.includes(card));
			if (invalidCards.length > 0) {
				showMessage(`These cards are not in your deck: ${invalidCards.join(', ')}. Please check your numbers.`);
				return;
			}
			
			gameState.hand = [...cardNumbers];
			cardNumbers.forEach(card => {
				gameState.deck = gameState.deck.filter(deckCard => deckCard !== card);
			});
			
			displayGameBoard();
		}
		
		function showMessage(message) {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Message</div>
				<div class="quest-description">${message}</div>
				<button class="next-btn" onclick="showHandInput(1)">OK</button>
			`;
		}

		function showGameNotice(message) {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Notice</div>
				<div class="quest-description" style="color: #FF6B6B;">${message}</div>
				<div class="hand-buttons">
					<button class="next-btn" onclick="displayGameBoard()">Return to Game</button>
				</div>
			`;
		}
		
		function reshuffleHand() {
			showHandInput(2);
		}
		
		function displayGameBoard() {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="game-board">
					<div class="board-section">
						<h3>Cards on Board</h3>
						<div class="cards-on-board" id="cardsOnBoard">
							${gameState.cardsOnBoard.length === 0 ? '<p style="color: #d4c4a0; text-align: center;">No cards played yet</p>' : 
							  gameState.cardsOnBoard.map(card => {
								const c = cardDatabase[card];
								const isLand = c.type === 'land';
								const isUsed = gameState.usedLandsThisTurn.includes(card);
								const classes = ['board-card'];
								if (isLand) classes.push('land-card', isUsed ? 'land-used' : 'land-ready');
								const clickAttr = isLand && !isUsed ? `onclick="activateLand(${card})"` : '';
								return `<div class="${classes.join(' ')}" ${clickAttr}>Card #${card}: ${c.type}${c.name ? ' - ' + c.name : ''}${isLand ? (isUsed ? ' (used)' : ' (ready)') : ''}</div>`;
							  }).join('')}
						</div>
					</div>
					
					<div class="board-section">
						<h3>Your Hand</h3>
						<div class="player-hand" id="playerHand">
							${gameState.hand.map(card => {
								const cardData = cardDatabase[card];
								const costDisplay = formatCardCost(cardData.cost);
								return `
								<div class="hand-card" onclick="selectCardToPlay(${card})">
									<div class="card-number">Card #${card}</div>
									<div class="card-type">${cardData.type}</div>
									${cardData.name ? `<div class="card-name">${cardData.name}</div>` : ''}
									<div class="card-cost">${costDisplay}</div>
								</div>
							`}).join('')}
						</div>
					</div>
					
					<div class="game-actions">
						<button class="next-btn" onclick="endTurn()">End Turn</button>
					</div>
				</div>
			`;
			updateManaDisplay();
			updateWayReductionAbilityUI();
			saveProgress();
		}
		
		function formatCardCost(cost) {
			if (!cost) return '<span class="free-cost">Free</span>';
			let costParts = [];
			if (cost.white) {
				for (let i = 0; i < cost.white; i++) {
					costParts.push(`<span class="mana-cost white-cost">W</span>`);
				}
			}
			if (cost.red) {
				for (let i = 0; i < cost.red; i++) {
					costParts.push(`<span class="mana-cost red-cost">R</span>`);
				}
			}
			if (cost.blue) {
				for (let i = 0; i < cost.blue; i++) {
					costParts.push(`<span class="mana-cost blue-cost">B</span>`);
				}
			}
			if (cost.any) {
				costParts.push(`<span class="mana-cost generic-cost">${cost.any}</span>`);
			}
			return costParts.length > 0 ? costParts.join('') : '<span class="free-cost">Free</span>';
		}
		
		function updateManaDisplay() {
			document.getElementById('whiteMana').textContent = gameState.mana.white;
			document.getElementById('redMana').textContent = gameState.mana.red;
			document.getElementById('blueMana').textContent = gameState.mana.blue;
			document.getElementById('roundNumber').textContent = gameState.currentRound;
		}
		
		function selectCardToPlay(cardNumber) {
			if (!gameState.hand.includes(cardNumber)) {
				showGameNotice('This card is not in your hand!');
				return;
			}
			const card = cardDatabase[cardNumber];

			if (card.type === 'way' && !checkWayCardConditions(cardNumber)) {
				return;
			}

			if (card.password && card.password !== '') {
				showPasswordDialog(cardNumber);
				return;
			}
			playCardDirectly(cardNumber);
		}
		
		function showPasswordDialog(cardNumber) {
			const card = cardDatabase[cardNumber];
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Enter Password</div>
				<div class="quest-description">
					Enter the password to unlock Card #${cardNumber} (${card.type}):
					<br><strong>${card.name || card.type}</strong>
				</div>
				<div class="hand-input-container">
					<input type="text" id="passwordInput" placeholder="Enter password..." class="hand-input" 
						   onkeypress="if(event.key === 'Enter') verifyPassword(${cardNumber})">
					<div class="hand-buttons">
						<button class="next-btn" onclick="verifyPassword(${cardNumber}); return false;">Unlock Card</button>
						<button class="next-btn" onclick="displayGameBoard(); return false;" style="background: #8B4513;">Cancel</button>
					</div>
				</div>
				<div style="background: rgba(139, 69, 19, 0.1); border: 1px solid rgba(139, 69, 19, 0.3); border-radius: 8px; padding: 15px; margin-top: 20px; font-family: 'Crimson Text', serif; color: #d4c4a0; font-size: 0.9rem;">
					<p><strong>Available cards in deck:</strong> ${gameState.deck.join(', ')}</p>
				</div>
			`;
		}
		
		function verifyPassword(cardNumber) {
			const passwordInput = document.getElementById('passwordInput');
			if (!passwordInput) {
				alert('Error: Password input field not found!');
				return;
			}
			
			const enteredPassword = passwordInput.value.trim();
			const card = cardDatabase[cardNumber];
			const masterPassword = 'master';
			
			if (enteredPassword !== card.password && enteredPassword !== masterPassword) {
				const questContent = document.querySelector('.quest-content');
				questContent.innerHTML = `
					<div class="quest-title">Incorrect Password</div>
					<div class="quest-description" style="color: #FF6B6B;">
						The password you entered is incorrect. Card #${cardNumber} was not played and remains in your hand.
					</div>
					<div class="hand-buttons">
						<button class="next-btn" onclick="showPasswordDialog(${cardNumber})" style="background: linear-gradient(135deg, #4682B4, #87CEEB);">Try Again</button>
						<button class="next-btn" onclick="displayGameBoard()">Return to Game</button>
					</div>
				`;
				return;
			}
			
			playCardDirectly(cardNumber);
		}
		
		function playCardDirectly(cardNumber) {
			const card = cardDatabase[cardNumber];

			if (card.type === 'way' && !checkWayCardConditions(cardNumber)) {
				return;
			}
			
			if (!canAffordCard(cardNumber)) {
				showGameNotice('You do not have enough mana to play this card. It remains in your hand.');
				return;
			}
			
			if (!card.cost) {
				finishPlayingCard(cardNumber);
				return;
			}
			
			payCardCost(cardNumber);
		}
		
		function canAffordCard(cardNumber) {
			const card = cardDatabase[cardNumber];
			if (!card.cost) return true;
			
			let cost = { ...card.cost };

			if (card.type === 'trial' && gameState.activeAbilities.includes(21)) {
				applyOnePointReduction(cost);
			}

			if (card.type === 'way' && gameState.wayCostReductionTurns > 0) {
				applyOnePointReduction(cost);
			}
			
			if (gameState.activeAbilities.includes(20)) {
				const totalManaNeeded = (cost.white || 0) + (cost.red || 0) + (cost.blue || 0) + (cost.any || 0);
				const totalManaAvailable = gameState.mana.white + gameState.mana.red + gameState.mana.blue;
				return totalManaAvailable >= totalManaNeeded;
			}
			
			if ((cost.white || 0) > gameState.mana.white) return false;
			if ((cost.red || 0) > gameState.mana.red) return false;
			if ((cost.blue || 0) > gameState.mana.blue) return false;
			if (cost.any) {
				const totalMana = gameState.mana.white + gameState.mana.red + gameState.mana.blue;
				const usedMana = (cost.white || 0) + (cost.red || 0) + (cost.blue || 0);
				if (totalMana - usedMana < cost.any) return false;
			}
			return true;
		}

		function applyOnePointReduction(cost) {
			if (cost.any && cost.any > 0) {
				cost.any -= 1;
			} else if (cost.white && cost.white > 0) {
				cost.white -= 1;
			} else if (cost.red && cost.red > 0) {
				cost.red -= 1;
			} else if (cost.blue && cost.blue > 0) {
				cost.blue -= 1;
			}
		}
		
		function payCardCost(cardNumber) {
			const card = cardDatabase[cardNumber];
			if (!card.cost) return;
			
			let cost = { ...card.cost };
			
			if (card.type === 'trial' && gameState.activeAbilities.includes(21)) {
				showLegolasReductionDialog(cardNumber, cost);
				return;
			}

			if (card.type === 'way' && gameState.wayCostReductionTurns > 0) {
				showWayReductionDialog(cardNumber, cost);
				return;
			}
			
			if (gameState.activeAbilities.includes(20)) {
				showBalinManaChoiceDialog(cardNumber, cost);
				return;
			}
			
			if (cost.white) gameState.mana.white -= cost.white;
			if (cost.red) gameState.mana.red -= cost.red;
			if (cost.blue) gameState.mana.blue -= cost.blue;
			if (cost.any) {
				showGenericManaChoiceDialog(cardNumber, cost.any);
				return;
			}
			
			finishPlayingCard(cardNumber);
		}

		function showWayReductionDialog(cardNumber, cost) {
			const options = [];
			if (cost.any && cost.any > 0) options.push({ type: 'any', label: 'Generic (colorless) mana' });
			if (cost.white && cost.white > 0) options.push({ type: 'white', label: 'White mana' });
			if (cost.red && cost.red > 0) options.push({ type: 'red', label: 'Red mana' });
			if (cost.blue && cost.blue > 0) options.push({ type: 'blue', label: 'Blue mana' });

			if (options.length === 0) {
				applyWayReduction(cardNumber, 'any'); 
				return;
			}

			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Paths Cost 1 Less</div>
				<div class="quest-description">
					Choose which mana you do NOT want to pay for this Way card.
				</div>
				<div class="hand-input-container">
					<div class="hand-buttons" style="flex-direction: column;">
						${options.map(opt => `
							<button class="next-btn" onclick="applyWayReduction(${cardNumber}, '${opt.type}')">
								Skip ${opt.label}
							</button>
						`).join('')}
						<button class="next-btn" onclick="displayGameBoard()" style="background:#8B4513;">Cancel</button>
					</div>
				</div>
			`;
		}

		function applyWayReduction(cardNumber, reducedType) {
			const original = cardDatabase[cardNumber];
			let cost = { ...(original.cost || {}) };

			if (reducedType === 'any' && cost.any) cost.any -= 1;
			else if (reducedType === 'white' && cost.white) cost.white -= 1;
			else if (reducedType === 'red' && cost.red) cost.red -= 1;
			else if (reducedType === 'blue' && cost.blue) cost.blue -= 1;

			if (gameState.activeAbilities.includes(20)) {
				showBalinManaChoiceDialog(cardNumber, cost);
				return;
			}

			if ((cost.white || 0) > gameState.mana.white || (cost.red || 0) > gameState.mana.red || (cost.blue || 0) > gameState.mana.blue) {
				showGameNotice('You do not have enough colored mana after the reduction.');
				return;
			}

			if (cost.white) gameState.mana.white -= cost.white;
			if (cost.red) gameState.mana.red -= cost.red;
			if (cost.blue) gameState.mana.blue -= cost.blue;

			if (cost.any && cost.any > 0) {
				showGenericManaChoiceDialog(cardNumber, cost.any);
				return;
			}

			finishPlayingCard(cardNumber);
		}
		
		function showLegolasReductionDialog(cardNumber, cost) {
			const questContent = document.querySelector('.quest-content');
			let options = [];
			if (cost.any && cost.any > 0) options.push({ type: 'any', label: 'Generic (colorless) mana' });
			if (cost.white && cost.white > 0) options.push({ type: 'white', label: 'White mana' });
			if (cost.red && cost.red > 0) options.push({ type: 'red', label: 'Red mana' });
			if (cost.blue && cost.blue > 0) options.push({ type: 'blue', label: 'Blue mana' });
			
			questContent.innerHTML = `
				<div class="quest-title">Legolas Ability Active</div>
				<div class="quest-description">
					Trial cards cost 1 less mana. Which mana type do you NOT want to pay?
				</div>
				<div class="hand-input-container">
					<div class="hand-buttons" style="flex-direction: column;">
						${options.map(opt => `
							<button class="next-btn" onclick="applyLegolasReduction(${cardNumber}, '${opt.type}')">
								Reduce ${opt.label}
							</button>
						`).join('')}
					</div>
				</div>
			`;
		}
		
		function applyLegolasReduction(cardNumber, reducedType) {
			const card = cardDatabase[cardNumber];
			let cost = { ...card.cost };
			
			if (reducedType === 'any' && cost.any) cost.any -= 1;
			else if (reducedType === 'white' && cost.white) cost.white -= 1;
			else if (reducedType === 'red' && cost.red) cost.red -= 1;
			else if (reducedType === 'blue' && cost.blue) cost.blue -= 1;
			
			if (gameState.activeAbilities.includes(20)) {
				showBalinManaChoiceDialog(cardNumber, cost);
				return;
			}

			if (cost.white) gameState.mana.white -= cost.white;
			if (cost.red) gameState.mana.red -= cost.red;
			if (cost.blue) gameState.mana.blue -= cost.blue;
			
			if (cost.any && cost.any > 0) {
				showGenericManaChoiceDialog(cardNumber, cost.any);
			} else {
				finishPlayingCard(cardNumber);
			}
		}
		
		function showBalinManaChoiceDialog(cardNumber, cost) {
			const totalCost = (cost.white || 0) + (cost.red || 0) + (cost.blue || 0) + (cost.any || 0);
			const questContent = document.querySelector('.quest-content');
			
			questContent.innerHTML = `
				<div class="quest-title">Balin Ability Active</div>
				<div class="quest-description">
					You can spend any color mana. Choose how to pay ${totalCost} mana total.<br>
					Available: W:${gameState.mana.white}, R:${gameState.mana.red}, B:${gameState.mana.blue}
				</div>
				<div class="hand-input-container">
					<input type="text" id="balinWhiteInput" placeholder="White mana (0-${gameState.mana.white})" class="hand-input" style="max-width: 200px;">
					<input type="text" id="balinRedInput" placeholder="Red mana (0-${gameState.mana.red})" class="hand-input" style="max-width: 200px;">
					<input type="text" id="balinBlueInput" placeholder="Blue mana (0-${gameState.mana.blue})" class="hand-input" style="max-width: 200px;">
					<div class="hand-buttons">
						<button class="next-btn" onclick="applyBalinPayment(${cardNumber}, ${totalCost})">Pay Mana</button>
						<button class="next-btn" onclick="displayGameBoard()" style="background: #8B4513;">Cancel</button>
					</div>
				</div>
			`;
		}
		
		function applyBalinPayment(cardNumber, totalCost) {
			const white = parseInt(document.getElementById('balinWhiteInput').value) || 0;
			const red = parseInt(document.getElementById('balinRedInput').value) || 0;
			const blue = parseInt(document.getElementById('balinBlueInput').value) || 0;
			
			if (white + red + blue !== totalCost) {
				showGameNotice(`You must pay exactly ${totalCost} mana total!`);
				return;
			}
			
			if (white > gameState.mana.white || red > gameState.mana.red || blue > gameState.mana.blue) {
				showGameNotice('You do not have enough mana of that color!');
				return;
			}
			
			gameState.mana.white -= white;
			gameState.mana.red -= red;
			gameState.mana.blue -= blue;
			
			finishPlayingCard(cardNumber);
		}
		
		function showGenericManaChoiceDialog(cardNumber, amount) {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Choose Mana to Spend</div>
				<div class="quest-description">
					Which mana do you want to spend for the generic cost of ${amount}?
				</div>
				<div class="hand-input-container">
					<div class="hand-buttons" style="flex-direction: column;">
						<button class="next-btn" onclick="spendGenericMana('white', ${amount}, ${cardNumber})" style="background: linear-gradient(135deg, #F5F5DC, #FFFACD); color: #2d1810;">
							White Mana (${gameState.mana.white} available)
						</button>
						<button class="next-btn" onclick="spendGenericMana('red', ${amount}, ${cardNumber})" style="background: linear-gradient(135deg, #B22222, #FF6B6B); color: #fff;">
							Red Mana (${gameState.mana.red} available)
						</button>
						<button class="next-btn" onclick="spendGenericMana('blue', ${amount}, ${cardNumber})" style="background: linear-gradient(135deg, #4682B4, #87CEEB); color: #fff;">
							Blue Mana (${gameState.mana.blue} available)
						</button>
					</div>
				</div>
			`;
		}
		
		function spendGenericMana(manaType, amount, cardNumber) {
			if (gameState.mana[manaType] < amount) {
				showGameNotice(`Not enough ${manaType} mana! The card remains in your hand.`);
				return;
			}
			gameState.mana[manaType] -= amount;
			finishPlayingCard(cardNumber);
		}
		
		function finishPlayingCard(cardNumber) {
			gameState.hand = gameState.hand.filter(c => c !== cardNumber);
			
			const card = cardDatabase[cardNumber];
			if (card.type === 'trial') {
				// goes to discard after effect
			} else {
				gameState.cardsOnBoard.push(cardNumber);
			}
			
			applyCardEffect(cardNumber);
		}
		
		function applyCardEffect(cardNumber) {
			const card = cardDatabase[cardNumber];
			switch (card.type) {
				case 'land':
					if (gameState.activeAbilities.includes(18)) {
						showDrawCardDialog('Treebeard ability triggered! Draw 1 card from the deck.', 18);
						return;
					}
					displayGameBoard();
					break;
				case 'hero':
					gameState.activeHeroes.push(cardNumber);
					if (!gameState.heroesWithFreeActivationThisTurn.includes(cardNumber)) {
						gameState.heroesWithFreeActivationThisTurn.push(cardNumber);
					}
					addAbility(cardNumber, card.ability, true);
					displayGameBoard();
					break;
				case 'trial':
					applyTrialEffect(cardNumber);
					gameState.discardPile.push(cardNumber);
					break;
				case 'way':
					showGameNotice('Congratulations! You have found a path to the artifact!');
					break;
			}
		}

		function activateLand(cardNumber) {
			if (gameState.usedLandsThisTurn.includes(cardNumber)) return;
			const card = cardDatabase[cardNumber];
			if (!card || card.type !== 'land') return;

			if (Array.isArray(card.choices) && card.choices.length > 0) {
				showLandManaChoice(cardNumber, card.choices);
				return;
			}

			if (card.effect.includes('Add 1 red mana')) {
				gameState.mana.red += 1;
			} else if (card.effect.includes('Add 1 white mana')) {
				gameState.mana.white += 1;
			} else if (card.effect.includes('Add 1 blue mana')) {
				gameState.mana.blue += 1;
			}

			gameState.usedLandsThisTurn.push(cardNumber);
			updateManaDisplay();
			displayGameBoard();
		}

		function showLandManaChoice(cardNumber, options) {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Choose Mana to Add</div>
				<div class="quest-description">
					This land can add one of the following. Choose which mana to add:
				</div>
				<div class="hand-input-container">
					<div class="hand-buttons" style="flex-direction: column;">
						${options.map(opt => {
							const label = opt === 'white' ? 'White' : opt === 'red' ? 'Red' : 'Blue';
							const style = opt === 'white'
								? "background: linear-gradient(135deg, #F5F5DC, #FFFACD); color: #2d1810;"
								: opt === 'red'
									? "background: linear-gradient(135deg, #B22222, #FF6B6B); color: #fff;"
									: "background: linear-gradient(135deg, #4682B4, #87CEEB); color: #fff;";
							return `
								<button class="next-btn" onclick="applyLandManaChoice(${cardNumber}, '${opt}')" style="${style}">
									Add 1 ${label} Mana
								</button>
							`;
						}).join('')}
						<button class="next-btn" onclick="displayGameBoard()" style="background:#8B4513;">Cancel</button>
					</div>
				</div>
			`;
		}

		function applyLandManaChoice(cardNumber, color) {
			if (gameState.usedLandsThisTurn.includes(cardNumber)) return;
			if (color === 'white') gameState.mana.white += 1;
			else if (color === 'red') gameState.mana.red += 1;
			else if (color === 'blue') gameState.mana.blue += 1;

			gameState.usedLandsThisTurn.push(cardNumber);
			updateManaDisplay();
			displayGameBoard();
		}
		
		function applyTrialEffect(cardNumber) {
			const card = cardDatabase[cardNumber];
			const multiplier = gameState.activeAbilities.includes(23) ? 2 : 1;
			
			if (cardNumber === 1) {
				if (gameState.mana.white >= 1) {
					gameState.mana.white -= 1;
					gameState.mana.blue += 1 * multiplier;
					gameState.mana.red += 1 * multiplier;
				}
				displayGameBoard();
			} else if (cardNumber === 2) {
				gameState.wayCostReductionTurns = Math.max(gameState.wayCostReductionTurns, 2);
				updateWayReductionAbilityUI();
				showGameNotice('Way cards will cost 1 less for this turn and the next.');
			} else if (cardNumber === 3) {
				const drawCount = 1 * multiplier;
				showDrawCardDialog(`Draw ${drawCount} card(s) from the deck.`);
			} else if (cardNumber === 4) {
				const manaToAdd = 2 * multiplier;
				showManaAddDialog(manaToAdd, 'Choose which color mana to add:');
			} else if (cardNumber === 5) {
				showDrawCardDialog('Draw 1 card from the deck.');
			} else if (cardNumber === 7) {
				const manaToAdd = 2 * multiplier;
				showManaAddDialog(manaToAdd, 'Add mana of any type your lands produce:');
			} else if (cardNumber === 8) {
				showDrawCardDialog('Choose a land card from your deck to add to your hand.');
			} else if (cardNumber === 9) {
				showDrawCardDialog('Tutor: Choose any one card from your deck to add to your hand.');
			} else if (cardNumber === 10) {
				const manaToAdd = 3 * multiplier;
				showManaAddDialog(manaToAdd, 'Choose which color mana to add:');
			} else if (cardNumber === 6) {
				displayGameBoard();
			} else {
				displayGameBoard();
			}
		}

		function updateWayReductionAbilityUI() {
			const abilitiesContainer = document.getElementById('abilitiesContainer');
			if (!abilitiesContainer) return;

			let el = document.getElementById('ability-way-reduction');
			if (gameState.wayCostReductionTurns > 0) {
				const label = `Paths cost 1 less (${gameState.wayCostReductionTurns} turn${gameState.wayCostReductionTurns === 1 ? '' : 's'} left)`;
				if (!el) {
					el = document.createElement('button');
					el.id = 'ability-way-reduction';
					el.className = 'ability-button active';
					el.style.cursor = 'not-allowed';
					el.textContent = label;
					abilitiesContainer.appendChild(el);
				} else {
					el.className = 'ability-button active';
					el.textContent = label;
				}
			} else {
				if (el) el.remove();
			}
		}

		function checkWayCardConditions(cardNumber) {
			if (cardNumber === 25) {
				if (!gameState.activeHeroes.includes(24)) {
					showGameNotice('Condition not met: Gollum (24) must be in the party to play this Way.');
					return false;
				}
			} else if (cardNumber === 28) {
				if (!gameState.activeHeroes.includes(19)) {
					showGameNotice('Condition not met: Frodo (19) must be in the party to play this Way.');
					return false;
				}
			} else if (cardNumber === 32) {
				if (!(gameState.activeHeroes.includes(23) && gameState.activeHeroes.includes(20))) {
					showGameNotice('Condition not met: Both Gimli (23) and Balin (20) must be in the party.');
					return false;
				}
			} else if (cardNumber === 33 || cardNumber === 34) {
				if (!gameState.activeHeroes.includes(21)) {
					showGameNotice('Condition not met: Legolas (21) must be in the party.');
					return false;
				}
			}
			return true;
		}
		
		function addAbility(heroNumber, abilityName, isFirstEntry) {
			const abilitiesContainer = document.getElementById('abilitiesContainer');
			
			const existingButton = document.getElementById(`ability-${heroNumber}`);
			if (existingButton) {
				existingButton.remove();
			}
			
			const abilityButton = document.createElement('button');
			abilityButton.className = 'ability-button';
			abilityButton.id = `ability-${heroNumber}`;
			
			const isActive = gameState.activeAbilities.includes(heroNumber);
			const wasUsed = gameState.usedAbilitiesThisTurn.includes(heroNumber);
			
			let statusClass = '';
			let isClickable = false;
			
			if (isActive) {
				statusClass = 'active';
				isClickable = false;
			} else if (wasUsed) {
				statusClass = 'used';
				isClickable = false;
			} else {
				statusClass = '';
				isClickable = true;
			}
			
			abilityButton.className = `ability-button ${statusClass}`;
			abilityButton.innerHTML = `${cardDatabase[heroNumber].name}: ${abilityName}`;
			
			if (isClickable) {
				abilityButton.onclick = function() {
					activateAbility(heroNumber);
				};
			} else {
				abilityButton.style.cursor = 'not-allowed';
			}
			
			abilitiesContainer.appendChild(abilityButton);
		}
		
		function activateAbility(heroNumber) {
			if (gameState.usedAbilitiesThisTurn.includes(heroNumber)) {
				showGameNotice(`${cardDatabase[heroNumber].name}'s ability has already been used this turn!`);
				return;
			}
			
			if (gameState.activeAbilities.includes(heroNumber)) {
				showGameNotice(`${cardDatabase[heroNumber].name}'s ability is already active!`);
				return;
			}
			
			if (gameState.heroesWithFreeActivationThisTurn.includes(heroNumber)) {
				gameState.heroesWithFreeActivationThisTurn = gameState.heroesWithFreeActivationThisTurn.filter(h => h !== heroNumber);
				activateAbilityEffect(heroNumber);
				return;
			}
			
			showAbilityManaDialog(heroNumber);
		}
		
		function activateAbilityEffect(heroNumber) {
			gameState.activeAbilities.push(heroNumber);
			gameState.usedAbilitiesThisTurn.push(heroNumber);
			
			const hero = cardDatabase[heroNumber];
			addAbility(heroNumber, hero.ability, false);
			
			if (heroNumber === 22) {
				showDrawCardDialog(`${cardDatabase[heroNumber].name}'s ability activated! Draw 1 extra card`, heroNumber);
			} else if (heroNumber === 24) {
				showGollumDiscardDialog();
			} else {
				displayGameBoard();
			}
		}
		
		function showAbilityManaDialog(heroNumber) {
			const questContent = document.querySelector('.quest-content');
			const hero = cardDatabase[heroNumber];
			
			const totalMana = gameState.mana.white + gameState.mana.red + gameState.mana.blue;
			
			if (totalMana === 0) {
				showGameNotice('You do not have any mana to activate this ability.');
				return;
			}
			
			questContent.innerHTML = `
				<div class="quest-title">Activate ${hero.name}'s Ability</div>
				<div class="quest-description">
					"<strong>${hero.ability}</strong>"<br><br>
					Pay 1 mana of any color to activate this ability for the rest of this turn.
				</div>
				<div class="hand-input-container">
					<div class="hand-buttons" style="flex-direction: column;">
						${gameState.mana.white > 0 ? `<button class="next-btn" onclick="payForAbility(${heroNumber}, 'white')" style="background: linear-gradient(135deg, #F5F5DC, #FFFACD); color: #2d1810;">
							Pay 1 White Mana (${gameState.mana.white} available)
						</button>` : ''}
						${gameState.mana.red > 0 ? `<button class="next-btn" onclick="payForAbility(${heroNumber}, 'red')" style="background: linear-gradient(135deg, #B22222, #FF6B6B); color: #fff;">
							Pay 1 Red Mana (${gameState.mana.red} available)
						</button>` : ''}
						${gameState.mana.blue > 0 ? `<button class="next-btn" onclick="payForAbility(${heroNumber}, 'blue')" style="background: linear-gradient(135deg, #4682B4, #87CEEB); color: #fff;">
							Pay 1 Blue Mana (${gameState.mana.blue} available)
						</button>` : ''}
						<button class="next-btn" onclick="displayGameBoard()" style="background: #8B4513;">Cancel</button>
					</div>
				</div>
			`;
		}
		
		function payForAbility(heroNumber, manaType) {
			if (gameState.mana[manaType] < 1) {
				showGameNotice('Not enough mana to activate this ability.');
				return;
			}
			
			gameState.mana[manaType] -= 1;
			activateAbilityEffect(heroNumber);
		}

		function showDrawCardDialog(message, sourceHeroNumber = null) {
			pendingAbilitySourceHero = sourceHeroNumber;
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Draw a Card</div>
				<div class="quest-description">
					${message}<br>
					Enter the card number you drew from the deck:
				</div>
				<div class="hand-input-container">
					<input type="text" id="drawCardInput" placeholder="Enter card number..." class="hand-input">
					<div class="hand-buttons">
						<button class="next-btn" onclick="drawSelectedCard()">Add to Hand</button>
					</div>
				</div>
				<div style="background: rgba(139, 69, 19, 0.1); border: 1px solid rgba(139, 69, 19, 0.3); border-radius: 8px; padding: 15px; margin-top: 20px; font-family: 'Crimson Text', serif; color: #d4c4a0; font-size: 0.9rem;">
					<p><strong>Available cards in deck:</strong> ${gameState.deck.join(', ')}</p>
				</div>
			`;
		}
		
		function drawSelectedCard() {
			const input = document.getElementById('drawCardInput');
			if (!input) return;
			
			const cardNumber = parseInt(input.value);
			
			if (!cardNumber || !gameState.deck.includes(cardNumber)) {
				showGameNotice('Invalid card number or card not in deck!');
				return;
			}
			
			gameState.hand.push(cardNumber);
			gameState.deck = gameState.deck.filter(card => card !== cardNumber);

			if (pendingAbilitySourceHero !== null) {
				if (pendingAbilitySourceHero === 22) {
					gameState.activeAbilities = gameState.activeAbilities.filter(h => h !== 22);
					const hero = cardDatabase[22];
					addAbility(22, hero.ability, false);
				}
				pendingAbilitySourceHero = null;
			}
			
			displayGameBoard();
		}
		
		function showGollumDiscardDialog() {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Gollum's Ability</div>
				<div class="quest-description">
					Take any card from the discard pile to your hand.
				</div>
				<div class="hand-input-container">
					${gameState.discardPile.length > 0 ? `
						<input type="text" id="gollumCardInput" placeholder="Enter card number..." class="hand-input">
						<div class="hand-buttons">
							<button class="next-btn" onclick="retrieveFromDiscard()">Take Card</button>
							<button class="next-btn" onclick="closeGollumAbility()" style="background: #8B4513;">Cancel</button>
						</div>
						<div style="background: rgba(139, 69, 19, 0.1); border: 1px solid rgba(139, 69, 19, 0.3); border-radius: 8px; padding: 15px; margin-top: 20px; font-family: 'Crimson Text', serif; color: #d4c4a0; font-size: 0.9rem;">
							<p>Cards in discard pile: ${gameState.discardPile.map(c => `#${c} (${cardDatabase[c].name || cardDatabase[c].type})`).join(', ')}</p>
						</div>
					` : `
						<p style="color: #d4c4a0; text-align: center; margin: 20px 0;">The discard pile is empty!</p>
						<button class="next-btn" onclick="closeGollumAbility()">OK</button>
					`}
				</div>
			`;
		}

		function closeGollumAbility() {
			gameState.activeAbilities = gameState.activeAbilities.filter(h => h !== 24);
			const hero = cardDatabase[24];
			addAbility(24, hero.ability, false);
			displayGameBoard();
		}
		
		function retrieveFromDiscard() {
			const numInput = document.getElementById('gollumCardInput');
			const cardNumber = parseInt(numInput && numInput.value);
			
			if (!cardNumber || !gameState.discardPile.includes(cardNumber)) {
				showGameNotice('Invalid card number or card not in discard pile!');
				return;
			}
			
			gameState.hand.push(cardNumber);
			gameState.discardPile = gameState.discardPile.filter(card => card !== cardNumber);
			
			closeGollumAbility();
		}
		
		function showManaAddDialog(amount, message) {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">Add Mana</div>
				<div class="quest-description">
					${message}<br>
					You can add ${amount} mana.
				</div>
				<div class="hand-input-container">
					<input type="text" id="whiteManaAdd" placeholder="White (0-${amount})" class="hand-input" style="max-width: 150px;">
					<input type="text" id="redManaAdd" placeholder="Red (0-${amount})" class="hand-input" style="max-width: 150px;">
					<input type="text" id="blueManaAdd" placeholder="Blue (0-${amount})" class="hand-input" style="max-width: 150px;">
					<div class="hand-buttons">
						<button class="next-btn" onclick="addSelectedMana(${amount})">Add Mana</button>
					</div>
				</div>
			`;
		}
		
		function addSelectedMana(totalAmount) {
			const white = parseInt(document.getElementById('whiteManaAdd').value) || 0;
			const red = parseInt(document.getElementById('redManaAdd').value) || 0;
			const blue = parseInt(document.getElementById('blueManaAdd').value) || 0;
			
			if (white + red + blue !== totalAmount) {
				showGameNotice(`You must add exactly ${totalAmount} mana total!`);
				return;
			}
			
			gameState.mana.white += white;
			gameState.mana.red += red;
			gameState.mana.blue += blue;
			
			displayGameBoard();
		}

		function proceedToNewTurnDraw() {
			const questContent = document.querySelector('.quest-content');
			questContent.innerHTML = `
				<div class="quest-title">New Turn - Round ${gameState.currentRound}</div>
				<div class="quest-description">
					Your turn has ended. All abilities and lands have been reset.<br><br>
					Draw 1 card from your deck to start the new round.
				</div>
				<div class="hand-input-container">
					<input type="text" id="newTurnCardInput" placeholder="Enter card number..." class="hand-input">
					<div class="hand-buttons">
						<button class="next-btn" onclick="drawNewTurnCard()">Draw Card</button>
					</div>
				</div>
				<div style="background: rgba(139, 69, 19, 0.1); border: 1px solid rgba(139, 69, 19, 0.3); border-radius: 8px; padding: 15px; margin-top: 20px; font-family: 'Crimson Text', serif; color: #d4c4a0; font-size: 0.9rem;">
					<p><strong>Available cards in deck:</strong> ${gameState.deck.join(', ')}</p>
				</div>
			`;
		}

		function exileRandomWayCard() {
			const protectedWays = new Set([29, 28, 34]);
			const wayCandidates = gameState.deck.filter(n => cardDatabase[n] && cardDatabase[n].type === 'way' && !protectedWays.has(n));
			if (wayCandidates.length === 0) return null;

			const idx = Math.floor(Math.random() * wayCandidates.length);
			const chosen = wayCandidates[idx];

			gameState.deck = gameState.deck.filter(n => n !== chosen);
			gameState.exiledCards.push(chosen);
			gameState.waysCardsRemaining = gameState.waysCardsRemaining.filter(n => n !== chosen);

			return chosen;
		}
		
        function endTurn() {
            gameState.currentRound++;

			gameState.mana.white = 0;
			gameState.mana.red = 0;
			gameState.mana.blue = 0;

            gameState.activeAbilities = [];
            gameState.usedAbilitiesThisTurn = [];
			gameState.heroesWithFreeActivationThisTurn = [];
			gameState.usedLandsThisTurn = [];
			if (gameState.wayCostReductionTurns > 0) {
				gameState.wayCostReductionTurns -= 1;
			}
            
            const abilitiesContainer = document.getElementById('abilitiesContainer');
            abilitiesContainer.innerHTML = '';
            gameState.activeHeroes.forEach(heroNumber => {
                const hero = cardDatabase[heroNumber];
                addAbility(heroNumber, hero.ability, false);
            });
			updateWayReductionAbilityUI();
            
            updateManaDisplay();

			saveProgress();

			const exiled = exileRandomWayCard();
			if (exiled !== null) {
				const questContent = document.querySelector('.quest-content');
				const name = `Way #${exiled}`;
				questContent.innerHTML = `
					<div class="quest-title">A Path Is Lost...</div>
					<div class="quest-description" style="color: #FF6B6B;">
						The forces of fate have destroyed a path forever: <strong>${name}</strong>.<br>
						Please remove this Way card from your deck.
					</div>
					<div class="hand-buttons">
						<button class="next-btn" onclick="proceedToNewTurnDraw()">Continue</button>
					</div>
				`;
				return;
			}
            
			proceedToNewTurnDraw();
        }
        
        function drawNewTurnCard() {
            const input = document.getElementById('newTurnCardInput');
            if (!input) return;
            
            const cardNumber = parseInt(input.value);
            
            if (!cardNumber || !gameState.deck.includes(cardNumber)) {
                showGameNotice('Invalid card number or card not in deck!');
                return;
            }
            
            gameState.hand.push(cardNumber);
            gameState.deck = gameState.deck.filter(card => card !== cardNumber);
            
            displayGameBoard();
        }
	</script>
</body>
</html>
